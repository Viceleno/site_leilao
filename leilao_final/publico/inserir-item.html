<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inserir Item no Leilão</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
</head>
<body>
  <div class="container mt-5">
    <div class="card mx-auto" style="max-width: 600px">
      <div class="card-body">
        <h1 class="text-center">Inserir Item no Leilão</h1>
        <form id="form-item">
          <div class="form-group">
            <label for="leilao_id">Leilão</label>
            <select class="form-control" id="leilao_id" required>
              <!-- Opções serão preenchidas dinamicamente -->
            </select>
          </div>
          <div class="form-group">
            <label for="nome">Nome do Item</label>
            <input type="text" class="form-control" id="nome" required />
          </div>
          <div class="form-group">
            <label for="descricao">Descrição</label>
            <textarea class="form-control" id="descricao" required></textarea>
          </div>
          <div class="form-group">
            <label for="lance_inicial">Lance Inicial</label>
            <input type="number" class="form-control" id="lance_inicial" required />
          </div>
          <button type="submit" class="btn btn-primary">Inserir Item</button>
        </form>
        <div id="itemAlert" class="alert alert-danger mt-3 d-none" role="alert"></div>
        <div class="mt-5">
          <h3 class="text-center">Itens Cadastrados</h3>
          <ul class="list-group" id="lista-itens">
            <!-- Itens serão preenchidos dinamicamente -->
          </ul>
        </div>
        <!-- Exibição da Hora Atual -->
        <p class="text-center mt-5" id="horaAtual">Carregando...</p>
      </div>
    </div>
  </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      $(document).ready(function () {
        // Preencher opções de leilões
        function carregarLeiloes() {
          $("#leilao_id").empty();
          $.get("/api/leiloes", function (data) {
            console.log('Dados recebidos do servidor:', data);
            data.forEach(function (leilao) {
              $("#leilao_id").append(new Option(`Leilão ${leilao.leilao_id}`, leilao.leilao_id));
            });
          }).fail(function (jqXHR) {
            console.error('Erro ao carregar leilões:', jqXHR.responseText);
            alert("Erro ao carregar leilões: " + jqXHR.responseText);
          });
        }

        // Listar itens cadastrados
        function listarItens() {
          $("#lista-itens").empty();
          $.get("/api/itens", function (data) {
            data.forEach(function (item) {
              $("#lista-itens").append(`
              <li class="list-group-item d-flex justify-content-between align-items-center">
                ${item.nome}
                <span>
                  <button class="btn btn-warning btn-sm atualizar-item" data-id="${item.item_id}">Atualizar</button>
                  <button class="btn btn-danger btn-sm apagar-item" data-id="${item.item_id}">Apagar</button>
                </span>
              </li>
            `);
            });
          }).fail(function () {
            alert("Erro ao carregar itens.");
          });
        }

        carregarLeiloes();
        listarItens();

        // Processar o formulário de item
        $("#form-item").on("submit", function (event) {
          event.preventDefault();
          const formData = {
            leilao_id: $("#leilao_id").val(),
            nome: $("#nome").val(),
            descricao: $("#descricao").val(),
            lance_inicial: $("#lance_inicial").val(),
          };
          $.post("/api/itens", formData, function (data) {
            if (data.success) {
              alert("Item inserido com sucesso!");
              listarItens();
            } else {
              $("#itemAlert")
                .removeClass("d-none")
                .text("Erro ao inserir item: " + data.error);
            }
          }).fail(function () {
            $("#itemAlert")
              .removeClass("d-none")
              .text("Erro ao processar o item");
          });
        });

        // Atualizar item
        $("#lista-itens").on("click", ".atualizar-item", function () {
          const itemId = $(this).data("id");
          const novoNome = prompt("Digite o novo nome do item:");
          const novaDescricao = prompt("Digite a nova descrição do item:");
          const novoLanceInicial = prompt(
            "Digite o novo lance inicial do item:"
          );
          if (novoNome && novaDescricao && novoLanceInicial) {
            $.ajax({
              url: `/api/itens/${itemId}`,
              type: "PUT",
              data: {
                nome: novoNome,
                descricao: novaDescricao,
                lance_inicial: novoLanceInicial,
              },
              success: function (data, status) {
                if (status === "success") {
                  alert("Item atualizado com sucesso!");
                  listarItens();
                } else {
                  $("#itemAlert")
                    .removeClass("d-none")
                    .text("Erro ao atualizar item: " + data.error);
                }
              },
              error: function () {
                $("#itemAlert")
                  .removeClass("d-none")
                  .text("Erro ao processar a atualização");
              },
            });
          }
        });

        // Apagar item
        $("#lista-itens").on("click", ".apagar-item", function () {
          const itemId = $(this).data("id");
          if (confirm("Tem certeza que deseja apagar este item?")) {
            $.ajax({
              url: `/api/itens/${itemId}`,
              type: "DELETE",
              success: function (data, status) {
                if (status === "success") {
                  alert("Item apagado com sucesso!");
                  listarItens();
                } else {
                  $("#itemAlert")
                    .removeClass("d-none")
                    .text("Erro ao apagar item: " + data.error);
                }
              },
              error: function () {
                $("#itemAlert")
                  .removeClass("d-none")
                  .text("Erro ao processar a exclusão");
              },
            });
          }
        });

        // Exibir hora atual (apenas hora e minuto)
        $.get("http://worldtimeapi.org/api/ip", function (data) {
          const hora = new Date(data.datetime).toLocaleTimeString("pt-BR", {
            hour: "2-digit",
            minute: "2-digit",
          });
          $("#horaAtual").text("Hora atual: " + hora);
        });
      });
    </script>
  </body>
</html>
